<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis总结 | 文档测试</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Curriculum Vitae">
    <link rel="preload" href="/assets/css/0.styles.40e1e164.css" as="style"><link rel="preload" href="/assets/js/app.1b94221b.js" as="script"><link rel="preload" href="/assets/js/2.60568d92.js" as="script"><link rel="preload" href="/assets/js/25.81b2ea1d.js" as="script"><link rel="prefetch" href="/assets/js/10.3d4294c4.js"><link rel="prefetch" href="/assets/js/11.14a477ac.js"><link rel="prefetch" href="/assets/js/12.a5ddb7e5.js"><link rel="prefetch" href="/assets/js/13.aae5c909.js"><link rel="prefetch" href="/assets/js/14.ab694e76.js"><link rel="prefetch" href="/assets/js/15.64315535.js"><link rel="prefetch" href="/assets/js/16.73da9ac4.js"><link rel="prefetch" href="/assets/js/17.a93d8ff3.js"><link rel="prefetch" href="/assets/js/18.b4ced15b.js"><link rel="prefetch" href="/assets/js/19.638c9ba4.js"><link rel="prefetch" href="/assets/js/20.b2eb7bf9.js"><link rel="prefetch" href="/assets/js/21.48394f3a.js"><link rel="prefetch" href="/assets/js/22.35e8a3cc.js"><link rel="prefetch" href="/assets/js/23.552730b3.js"><link rel="prefetch" href="/assets/js/24.e9135eeb.js"><link rel="prefetch" href="/assets/js/26.75302b23.js"><link rel="prefetch" href="/assets/js/27.9e876760.js"><link rel="prefetch" href="/assets/js/28.57922220.js"><link rel="prefetch" href="/assets/js/29.68fbb04d.js"><link rel="prefetch" href="/assets/js/3.fe45d089.js"><link rel="prefetch" href="/assets/js/30.a98a6693.js"><link rel="prefetch" href="/assets/js/31.8202c39f.js"><link rel="prefetch" href="/assets/js/32.febfda4f.js"><link rel="prefetch" href="/assets/js/33.5ae3ee39.js"><link rel="prefetch" href="/assets/js/34.15947107.js"><link rel="prefetch" href="/assets/js/35.d3f8c53a.js"><link rel="prefetch" href="/assets/js/36.b7fee681.js"><link rel="prefetch" href="/assets/js/37.c13c8f17.js"><link rel="prefetch" href="/assets/js/38.793a8df9.js"><link rel="prefetch" href="/assets/js/4.4d86075a.js"><link rel="prefetch" href="/assets/js/5.d5b9441a.js"><link rel="prefetch" href="/assets/js/6.19d672a5.js"><link rel="prefetch" href="/assets/js/7.5f6998cb.js"><link rel="prefetch" href="/assets/js/8.f35ecf57.js"><link rel="prefetch" href="/assets/js/9.99850ec9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.40e1e164.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档测试</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/learning-notes/" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhaotbj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/learning-notes/" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhaotbj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/数据库/redis的原子性.html" class="sidebar-link">redis的原子性</a></li><li><a href="/数据库/MongoDB总结.html" class="sidebar-link">MongoDB总结</a></li><li><a href="/数据库/redis的数据库.html" class="sidebar-link">redis的数据库</a></li><li><a href="/数据库/MySQL基础与高级.html" class="sidebar-link">基础</a></li><li><a href="/数据库/MongoDB权威指南.html" class="sidebar-link">MongoDB权威指南</a></li><li><a href="/数据库/redis设计与实现.html" class="sidebar-link">数据结构与对象</a></li><li><a href="/数据库/MySQL的join原理.html" class="sidebar-link">/数据库/MySQL的join原理.html</a></li><li><a href="/数据库/MySQL性能优化.html" class="sidebar-link">/数据库/MySQL性能优化.html</a></li><li><a href="/数据库/MySQL总结.html" class="sidebar-link">MySQL总结</a></li><li><a href="/数据库/乐观锁和悲观锁.html" class="sidebar-link">乐观锁和悲观锁</a></li><li><a href="/数据库/redis(图灵学院).html" class="sidebar-link">什么是Redis</a></li><li><a href="/数据库/Redis总结.html" class="active sidebar-link">Redis总结</a></li><li><a href="/数据库/Redis底层数据结构及其编码和优点.html" class="sidebar-link">Redis底层数据结构及其编码和优点</a></li><li><a href="/数据库/MySQL索引最佳实践.html" class="sidebar-link">/数据库/MySQL索引最佳实践.html</a></li><li><a href="/数据库/redis的事件.html" class="sidebar-link">Redis的事件</a></li><li><a href="/数据库/springboot使用h2数据库.html" class="sidebar-link">/数据库/springboot使用h2数据库.html</a></li><li><a href="/数据库/关于NoSQL.html" class="sidebar-link">NoSQL数据库的四大分类</a></li><li><a href="/数据库/布隆过滤器.html" class="sidebar-link">布隆过滤器</a></li><li><a href="/数据库/数据库基础和规范.html" class="sidebar-link">数据库建表规则（三大范式）</a></li><li><a href="/数据库/索引优化ORDER BY排序语句.html" class="sidebar-link">索引优化ORDER BY排序语句</a></li><li><a href="/数据库/覆盖索引，回表查询.html" class="sidebar-link">覆盖索引，回表查询</a></li><li><a href="/数据库/高性能MySQL.html" class="sidebar-link">MySQL架构与历史</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis总结"><a href="#redis总结" class="header-anchor">#</a> Redis总结</h1> <p><strong>1、redis和memcached的区别，为什么单线程的redis有时比memcached的效率高</strong></p> <p>​		1、memcached可以存储图片或者视频，redis支持key/value的很多数据结构</p> <p>​		2、redis可以使用虚拟内存。可以通过RDB和AOF进行持久化和灾难恢复。redis支持主从备份。</p> <p>​		3、redis可以做消息队列。</p> <p>​		原因：<strong>memcached</strong>多线程模型引入了<strong>缓存一致性</strong>和<strong>锁</strong>，<strong>加锁带来了性能损耗</strong>。</p> <p><strong>2、redis 主从复制如何实现的？redis的集群模式如何实现？redis的key是如何寻址的？</strong><img src="F:%5CtyporaImg%5C1582196748156.png" alt="1582196748156"></p> <p>​		寻址：http://blog.itpub.net/69917606/viewspace-2642545/</p> <p><strong>3、使用redis实现分布式锁？实现思路？使用zk可以吗？怎么实现？这两种有什么区别？</strong></p> <p>​		可以使用redis的setnx()方法</p> <p>​		1、线程A setnx()，设置超时时间t1，如果返回true，则获得锁</p> <p>​		2、线程B用get获取t1，判断是否超时。如果超时了，则执行第三步、没超时返回false。</p> <p>​		3、计算新的超时时间t2，使用getset()返回t3，如果t3==t1的话，则获得锁（CAS原理）。否则，说明锁被其它线程获取了。</p> <p>​		4、获取锁后，处理完业务逻辑，<strong>先判断锁是否超时</strong>，如果没超时则删除锁，如果超时，不用处理。（防止删除其它线程获得的锁）。</p> <p><strong>4、redis的持久化？底层是怎么实现的？有什么优缺点？</strong></p> <p>​		RDB(redis database)：在不同时间点将redis的<strong>数据生成的快照同步到磁盘</strong>等介质，定期更新。缺点：耗时，性能低（I/O），易丢失数据。（数据同步到磁盘）</p> <p>​		AOF(append only file): 将redis执行过的所有指令记录下来（记录执行指令）。下次重启时，只需要重新执行所有的指令。缺点：体积大，恢复速度慢。</p> <p><strong>5、redis过期策略有哪些？LRU算法的实现？</strong></p> <p>​		1、定时过期（定时清理过期的key）</p> <p>​		2、惰性过期（当用到key的时候才判断是否过期和是否清理）</p> <p>​		3、LRU算法（保证不常用的数据在队列的后面）原理FIFO</p> <p>​			LRU实现：使用双向链表LinkedHashMap实现。（HashMap是无序的，LinkedHashMap维护了迭代顺序。）</p> <p>​			1、新的数据插到链表头部</p> <p>​			2、缓存命中的时候，将数据移到链表头</p> <p>​			3、链表满的时候，将链表后面的数据丢弃。</p> <p><strong>6、缓存穿透、缓存击穿、缓存雪崩的解决方案？</strong></p> <p>​		缓存穿透：指定不存在的数据，存储层查不到数据则不写入缓存。导致这个不存在的数据每次请求都到DB去查询。可能导致DB挂掉。</p> <p>​		解决方案：1、将这个key缓存起来，设置较短的过期时间 2、一个Map来保存这些key，作为一个过滤器。如果有key，则不请求DB。</p> <hr> <p>​		缓存击穿：一个设置了过期时间的key在某个时间点过期，刚好那时有大量请求该数据。导致全部请求到达DB，导致DB挂掉。</p> <p>​		解决方案：1、使用互斥锁，setnx()。当一个缓存失效时，请求先不请求DB，先加个互斥锁，其他线程等待。然后再请求DB数据缓存起来，释放锁后其它线程即可直接访问缓存了。2、永不过期</p> <hr> <p>​		缓存雪崩：设置了很多<strong>相同过期时间</strong>的热点数据，当过期时大量请求直接请求数据库，导致DB挂掉。</p> <p>​		解决方案：</p> <p>​			**事前：**1、在设置过期时间的时候可以设置加上一个随机值，防止大量key同时失效。2、搭建redis集群。</p> <p>​			**事后：**1、通过加锁或者入队列的方式对请求数据库和写缓存的线程进行限制。只允许一个线程查询数据和写入缓存。释放锁后其它线程即可查询新写入缓存的数据了。</p> <p><strong>7、选择缓存的时候，什么时候选redis，什么时候选择memcached？</strong></p> <p>​		选<strong>redis</strong>：1、需要复杂的数据结构。2、需要数据持久化的功能。3、高可用场景，redis支持集群。可实现主动复制，读写分离。对于memcached要实现高可用，需进行二次开发。4、存储内容比较大，memcached存储的value最大为1M。</p> <p>​		选<strong>memcached</strong>：1、纯K/V，数据量很大的业务。</p> <p><img src="F:%5CtyporaImg%5C1582201193241.png" alt="1582201193241"></p> <p>2、网络模型，memcached是非阻塞的IO复用模型。</p> <p>3、线程模型，memcached使用多线程，主线程监听，worker子线程接收请求，执行读写。充分利用多核性能提升吞吐量。</p> <p><strong>8、缓存与数据库不一致怎么办？</strong></p> <p><img src="F:%5CtyporaImg%5C1582201379625.png" alt="1582201379625"></p> <p><strong>9、主从数据库不一致怎么办？</strong><img src="F:%5CtyporaImg%5C1582201558749.png" alt="1582201558749"></p> <p><strong>10、redis常见的性能问题和解决方案</strong><img src="F:%5CtyporaImg%5C1582201614010.png" alt="1582201614010"></p> <p><strong>11、redis的数据淘汰策略有哪些？</strong></p> <p>​		<strong>voltile-lru</strong> 从设置过期时间的数据集中挑选<strong>最近最少使用</strong>的数据淘汰。</p> <p>​		<strong>voltile-ttl</strong> 从设置了过期时间的数据集中挑选<strong>将要过期</strong>的数据。</p> <p>​		<strong>voltile-random</strong> 从设置了过期时间的数据集中<strong>任意随机</strong>选择淘汰数据。</p> <p>​		<strong>allkeys-lru</strong> 从数据集中挑选最近最少使用的数据淘汰。</p> <div class="language- extra-class"><pre><code>**allkeys-random** 从数据集中任意随机体挑选数据淘汰。
</code></pre></div><p>​		<strong>no-eviction</strong> 禁止驱逐数据。</p> <p><strong>13、redis中有一亿个key，其中有10w个key是以固定的已知前缀开头，如何找出来？</strong></p> <p>​		使用<strong>keys+通配符</strong>的方法列出所有一直前缀的key ，比如前缀是like <code>keys like*</code></p> <p>​		使用keys的问题：因为redis是单线程的，key数据量太大的话会阻塞一段时间才可进行其它业务</p> <p>​		更好的方式：使用<strong>scan</strong>指令，scan指令可以无阻塞的提取出指定模式的key列表，但是会<strong>有一定的重复概率</strong>，需要去重。整体花费的时间比keys指令长。<code>scan 0 match *like</code></p> <p><strong>14、redis怎么做异步队列，怎么实现？</strong></p> <p>​		使用list保存数据，rpush生产消息，lpop消费消息。当lpop没有消息时，可以sleep一段时间，再去检查。如果不用sleep的话，可以使用blpop，再没有消息的时候，会一直阻塞。知道消息到来。</p> <p>​		为什么blpop会阻塞？redis不是单线程的吗？其它命令还能执行吗</p> <p><img src="F:%5CtyporaImg%5C1582203192441.png" alt="1582203192441"></p> <p><strong>15、redis如何实现延时队列？</strong></p> <p>​		使用<strong>sortedset</strong>，使用时间戳作为score，消息内容作为key，调用zadd来生产消息。消费者使用<strong>zrangebyscore</strong>获取n秒前的数据做轮询处理。</p> <p><strong>16、什么是redis？他的优缺点？</strong></p> <p>​		key/value类型的内存数据库，缓存数据库。定期通过异步操作将数据flush到硬盘上保存。数据类型很多，可以利用这个特点做很多服务（消息队列，延时队列）。</p> <p>​		缺点：因内存的限制，不能用作海量数据的高性能读写。主要用于叫小数据量的高性能操作和运算上。</p> <p><strong>17、redis相比memcached的优势</strong><img src="F:%5CtyporaImg%5C1582203771944.png" alt="1582203771944"></p> <p><strong>18、redis的集群方案应该怎么做？有哪些方案？</strong></p> <p>Redis Cluster 是 Redis 的分布式解决方案，在 Redis 3.0 版本正式推出的。</p> <p>Redis Cluster 去中心化，每个节点保存数据和整个集群状态，每个节点都和其他所有节点连接。</p> <p><strong>Redis Cluster 节点分配</strong></p> <p>参考：https://www.jianshu.com/p/26e61d1161af</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 在redis安装目录常见cluster文件夹，在创建端口对应文件夹和配置文件
// 安装命令
redis-server --service-install cluster/7100/redis.7100.conf --service-name redis7100
// 卸载命令
redis-server --service-uninstall --service-name redis7100
// 启动命令
redis-server --service-start --service-name redis7100
// 停止命令
redis-server --service-stop --service-name redis7100
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Redis Cluster 特点：</p> <ol><li>所有的 redis 节点彼此互联(PING-PONG 机制)，内部使用二进制协议优化传输速度和带宽。</li> <li>节点的 fail 是通过集群中超过半数的节点检测失效时才生效。</li> <li>客户端与 redis 节点直连,不需要中间 proxy 层。客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可。</li> <li>redis-cluster 把所有的物理节点映射到[0-16383] 哈希槽 (hash slot)上（不一定是平均分配）,cluster 负责维护 node、slot、value。</li> <li>Redis 集群预分好 16384 个桶，当需要在 Redis 集群中放置一个 key-value 时，根据 CRC16(key) mod 16384 的值，决定将一个 key 放到哪个桶中。</li></ol> <p><strong>Redis Cluster 主从模式</strong></p> <p>Redis Cluster 为了保证数据的高可用性，加入了主从模式。</p> <p>一个主节点对应一个或多个从节点，主节点提供数据存取，从节点则是从主节点拉取数据备份。当这个主节点挂掉后，就会有这个从节点选取一个来充当主节点，从而保证集群不会挂掉。所以，在集群建立的时候，一定要为每个主节点都添加了从节点。</p> <hr> <p><strong>Redis Sentinel</strong></p> <p>Redis Sentinel 用于管理多个 Redis 服务器，它有三个功能：</p> <ul><li><strong>监控（Monitoring）</strong>  - Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li> <li><strong>提醒（Notification）</strong>  - 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li> <li><strong>自动故障迁移（Automatic failover）</strong>  - 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li></ul> <p>Redis 集群中应该有奇数个节点，所以至少有三个节点。</p> <p>哨兵监控集群中的主服务器出现故障时，需要根据 quorum 选举出一个哨兵来执行故障转移。选举需要 majority，即大多数哨兵是运行的（2 个哨兵的 majority=2，3 个哨兵的 majority=2，5 个哨兵的 majority=3，4 个哨兵的 majority=2）。</p> <p>假设集群仅仅部署 2 个节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+----+         +----+| M1 |---------| R1 || S1 |         | S2 |+----+         +----+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果 M1 和 S1 所在服务器宕机，则哨兵只有 1 个，无法满足 majority 来进行选举，就不能执行故障转移。</p> <p><strong>redis-cluster通信协议</strong></p> <p>redis cluster节点间采取gossip协议进行通信</p> <p>gossip协议包含多种消息，包括ping，pong，meet，fail等等。</p> <ul><li><p>meet：某个节点发送meet给新加入的节点，让新节点加入集群中，然后新节点就会开始与其他节点进行通信；</p></li> <li><p>ping：每个节点都会频繁给其他节点发送ping，其中包含自己的状态还有自己维护的集群元数据，互相通过ping交换元数据；</p></li> <li><p>pong: 返回ping和meet，包含自己的状态和其他信息，也可以用于信息广播和更新；</p></li> <li><p>fail: 某个节点判断另一个节点fail之后，就发送fail给其他节点，通知其他节点，指定的节点宕机了。</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/数据库/redis(图灵学院).html" class="prev">
        什么是Redis
      </a></span> <span class="next"><a href="/数据库/Redis底层数据结构及其编码和优点.html">
        Redis底层数据结构及其编码和优点
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b94221b.js" defer></script><script src="/assets/js/2.60568d92.js" defer></script><script src="/assets/js/25.81b2ea1d.js" defer></script>
  </body>
</html>
