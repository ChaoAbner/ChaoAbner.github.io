<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis的事件 | 文档测试</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Curriculum Vitae">
    <link rel="preload" href="/assets/css/0.styles.40e1e164.css" as="style"><link rel="preload" href="/assets/js/app.1b94221b.js" as="script"><link rel="preload" href="/assets/js/2.60568d92.js" as="script"><link rel="preload" href="/assets/js/27.9e876760.js" as="script"><link rel="prefetch" href="/assets/js/10.3d4294c4.js"><link rel="prefetch" href="/assets/js/11.14a477ac.js"><link rel="prefetch" href="/assets/js/12.a5ddb7e5.js"><link rel="prefetch" href="/assets/js/13.aae5c909.js"><link rel="prefetch" href="/assets/js/14.ab694e76.js"><link rel="prefetch" href="/assets/js/15.64315535.js"><link rel="prefetch" href="/assets/js/16.73da9ac4.js"><link rel="prefetch" href="/assets/js/17.a93d8ff3.js"><link rel="prefetch" href="/assets/js/18.b4ced15b.js"><link rel="prefetch" href="/assets/js/19.638c9ba4.js"><link rel="prefetch" href="/assets/js/20.b2eb7bf9.js"><link rel="prefetch" href="/assets/js/21.48394f3a.js"><link rel="prefetch" href="/assets/js/22.35e8a3cc.js"><link rel="prefetch" href="/assets/js/23.552730b3.js"><link rel="prefetch" href="/assets/js/24.e9135eeb.js"><link rel="prefetch" href="/assets/js/25.81b2ea1d.js"><link rel="prefetch" href="/assets/js/26.75302b23.js"><link rel="prefetch" href="/assets/js/28.57922220.js"><link rel="prefetch" href="/assets/js/29.68fbb04d.js"><link rel="prefetch" href="/assets/js/3.fe45d089.js"><link rel="prefetch" href="/assets/js/30.a98a6693.js"><link rel="prefetch" href="/assets/js/31.8202c39f.js"><link rel="prefetch" href="/assets/js/32.febfda4f.js"><link rel="prefetch" href="/assets/js/33.5ae3ee39.js"><link rel="prefetch" href="/assets/js/34.15947107.js"><link rel="prefetch" href="/assets/js/35.d3f8c53a.js"><link rel="prefetch" href="/assets/js/36.b7fee681.js"><link rel="prefetch" href="/assets/js/37.c13c8f17.js"><link rel="prefetch" href="/assets/js/38.793a8df9.js"><link rel="prefetch" href="/assets/js/4.4d86075a.js"><link rel="prefetch" href="/assets/js/5.d5b9441a.js"><link rel="prefetch" href="/assets/js/6.19d672a5.js"><link rel="prefetch" href="/assets/js/7.5f6998cb.js"><link rel="prefetch" href="/assets/js/8.f35ecf57.js"><link rel="prefetch" href="/assets/js/9.99850ec9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.40e1e164.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">文档测试</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/learning-notes/" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhaotbj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/learning-notes/" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/reading/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhaotbj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/数据库/redis的原子性.html" class="sidebar-link">redis的原子性</a></li><li><a href="/数据库/MongoDB总结.html" class="sidebar-link">MongoDB总结</a></li><li><a href="/数据库/redis的数据库.html" class="sidebar-link">redis的数据库</a></li><li><a href="/数据库/MySQL基础与高级.html" class="sidebar-link">基础</a></li><li><a href="/数据库/MongoDB权威指南.html" class="sidebar-link">MongoDB权威指南</a></li><li><a href="/数据库/redis设计与实现.html" class="sidebar-link">数据结构与对象</a></li><li><a href="/数据库/MySQL的join原理.html" class="sidebar-link">/数据库/MySQL的join原理.html</a></li><li><a href="/数据库/MySQL性能优化.html" class="sidebar-link">/数据库/MySQL性能优化.html</a></li><li><a href="/数据库/MySQL总结.html" class="sidebar-link">MySQL总结</a></li><li><a href="/数据库/乐观锁和悲观锁.html" class="sidebar-link">乐观锁和悲观锁</a></li><li><a href="/数据库/redis(图灵学院).html" class="sidebar-link">什么是Redis</a></li><li><a href="/数据库/Redis总结.html" class="sidebar-link">Redis总结</a></li><li><a href="/数据库/Redis底层数据结构及其编码和优点.html" class="sidebar-link">Redis底层数据结构及其编码和优点</a></li><li><a href="/数据库/MySQL索引最佳实践.html" class="sidebar-link">/数据库/MySQL索引最佳实践.html</a></li><li><a href="/数据库/redis的事件.html" class="active sidebar-link">Redis的事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/数据库/redis的事件.html#文件事件" class="sidebar-link">文件事件</a></li><li class="sidebar-sub-header"><a href="/数据库/redis的事件.html#时间事件" class="sidebar-link">时间事件</a></li><li class="sidebar-sub-header"><a href="/数据库/redis的事件.html#事件的调度和执行" class="sidebar-link">事件的调度和执行</a></li><li class="sidebar-sub-header"><a href="/数据库/redis的事件.html#重点回顾" class="sidebar-link">重点回顾</a></li></ul></li><li><a href="/数据库/springboot使用h2数据库.html" class="sidebar-link">/数据库/springboot使用h2数据库.html</a></li><li><a href="/数据库/关于NoSQL.html" class="sidebar-link">NoSQL数据库的四大分类</a></li><li><a href="/数据库/布隆过滤器.html" class="sidebar-link">布隆过滤器</a></li><li><a href="/数据库/数据库基础和规范.html" class="sidebar-link">数据库建表规则（三大范式）</a></li><li><a href="/数据库/索引优化ORDER BY排序语句.html" class="sidebar-link">索引优化ORDER BY排序语句</a></li><li><a href="/数据库/覆盖索引，回表查询.html" class="sidebar-link">覆盖索引，回表查询</a></li><li><a href="/数据库/高性能MySQL.html" class="sidebar-link">MySQL架构与历史</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis的事件"><a href="#redis的事件" class="header-anchor">#</a> Redis的事件</h1> <p>Redis是一个事件驱动型的程序。Redis服务器会产生两类事件。</p> <ul><li><p>文件事件（file event）</p> <p>Redis通过套接字与客户端进行连接。而文件事件就是Redis对套接字操作的抽象。Redis服务器与客户端之间的通信会产生一些事件，服务器则监听并处理这些事件完成一系列的网络通信操作。</p></li> <li><p>时间事件（time event）</p> <p>Redis中的一些操作（如serverCron函数）需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象。</p></li></ul> <h2 id="文件事件"><a href="#文件事件" class="header-anchor">#</a> 文件事件</h2> <p>Redis基于Reactor模式开发了自己的网络事件处理器：这个处理器被称为<strong>文件事件处理器</strong></p> <ul><li><p>文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并
根据套接字目前执行的任务来为套接字关联不同的事件处理器。</p></li> <li><p>当被监听的套接字准备好执行连接应答（accept）、读取（read）、写人（write）、关
闭（close）等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就
会调用套接字之前关联好的事件处理器来处理这些事件。</p></li></ul> <p>虽然<strong>文件事件处理器</strong>以<strong>单线程</strong>方式运行，但通过使用<strong>I/O多路复用程序来监听多个套接</strong> <strong>字</strong>，文件事件处理器既实现了高性能的网络通信模型，又可以很好地与Redis服务器中其他
同样以单线程方式运行的模块进行对接，这保持了Redis内部单线程设计的简单性。</p> <h3 id="文件事件处理器"><a href="#文件事件处理器" class="header-anchor">#</a> 文件事件处理器</h3> <h4 id="构成"><a href="#构成" class="header-anchor">#</a> 构成</h4> <p>文件事件处理器由四个组成部分，套接字，I/O多路复用程序，文件事件分发器（dispatcher），事件处理器。</p> <p><img src="http://img.fosuchao.com/20200522172250.png" alt=""></p> <h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <p>文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答（accept）、写人、读取、关闭等操作时，就会产生一个文件事件。因为一个服务器通常会连接多个套接字，所以多个文件事件有可能会并发地出现。</p> <p>I/O多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。</p> <p>尽管多个文件事件可能会并发地出现，但<strong>I/O多路复用程序</strong>总是会将所有产生事件的<strong>套接字</strong>都放到一<strong>个队列</strong>里面，然后通过这个队列，以<strong>有序</strong>（sequentially）、<strong>同步</strong>（synchronously）、每次一个套接字的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完毕之后（该套接字为事件所关联的事件处理器执行完毕)，I/O多路复用程序才会继续向文件事件分派器传送下一个套接字，如下图所示。</p> <p><img src="http://img.fosuchao.com/20200522172610.png" alt=""></p> <h4 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h4> <p><strong>连接应答处理器</strong></p> <p>当Redis服务器进行<strong>初始化的时候</strong>，程序会将这个<strong>连接应答处理器和服务器监听套接字</strong>的<code>AE_READABLE</code>事件关联起来，当有客户端用<code>sys/socket.h/connect</code>函数连接服务器监听套接字的时候，套接字就会产生<code>AE_READABLE</code>事件，引发连接应答处理器执行，并执行相应的套接字应答操作。</p> <p><strong>命令请求处理器</strong></p> <p>当一个客户端通过<strong>连接应答处理器成功连接到服务器</strong>之后，服务器会将<strong>客户端套接字的事件和命令请求处理器关联起来</strong>，当客户端向服务器发送命令请求的时候，套接字就会产生AE事件，引发命令请求处理器执行，并执行相应的套接字读操作。</p> <p>客户端连接服务器的整个过程中。服务器都会一直为客户端套接字的<code>AE_READABLE</code>事件关联命令请求处理器。</p> <p><strong>命令回复处理器</strong></p> <p>当服务器有<strong>命令回复需要传送给客户端</strong>的时候，服务器会将<strong>客户端套接字的事件和命令回复处理器关联起来</strong>，当客户端准备好接收服务器传回的命令回复时，就会产生<code>AE_WRITABLE</code>事件，引发命令回复处理器执行，并执行相应的套接字<strong>写入</strong>操作。</p> <p>服务器与客户端通信的整个过程如下图</p> <p><img src="http://img.fosuchao.com/20200522173655.png" alt=""></p> <h2 id="时间事件"><a href="#时间事件" class="header-anchor">#</a> 时间事件</h2> <p>Redis的时间事件分为以下两类：</p> <ul><li><p><strong>定时事件</strong>：让一段程序在指定的时间之后执行一次。比如说，让程序X在当前时间的30毫秒之后执行一次。</p></li> <li><p><strong>周期性事件</strong>：让一段程序每隔指定时间就执行一次。比如说，让程序Y每隔30毫秒就执行一次。</p></li></ul> <p>一个时间事件主要由以下三个属性组成：</p> <ul><li><p>id：服务器为时间事件创建的全局唯一ID（标识号）。ID号按从小到大的顺序递增，新事件的ID号比旧事件的ID号要大。</p></li> <li><p>when:毫秒精度的时间戳，记录了时间事件的到达（arrive）时间。</p></li> <li><p>timeProc：时间事件处理器，一个函数。当时间事件到达时，服务器就会调用相应的处理器来处理事件。</p></li></ul> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <p>Redis将所有的时间事件都放在一个无序链表中。每当时间事件执行器运行时，它就会遍历整个链表，检查到达执行时间的时间事件。并进行执行处理。</p> <p>链表按id逆序排序，但是时间是无序的。</p> <p><img src="http://img.fosuchao.com/20200522174037.png" alt=""></p> <p><strong>性能问题</strong></p> <p>很多人可能会想，无序链表的遍历不会造成效率问题吗？为什么不直接按照时间来排序呢，将时间小的排在前面，那么直到遍历到未来的时间（未达到执行时间）的时候就可以不遍历了。</p> <p>其实这里的无序链表并不会影响性能。</p> <p>在目前版本中，正常模式下的Redis服务器只使用<code>servercron</code>一个时间事件，而在benchmark模式下，服务器也只使用两个时间事件。在这种情况下，服务器几乎是将无序裢表退化成一个指针来使用，所以使用无序撻表来保存时间事件，并不影响事件执行的性能。</p> <h3 id="servercron函数"><a href="#servercron函数" class="header-anchor">#</a> serverCron函数</h3> <p>持续运行的Redis服务器需要定期对自身的资源和状态进行检查和调整，从而确保服务器可以长期、稳定地运行，这些定期操作由redis.c/servercron函数负责执行，它的主要工作包括：</p> <ul><li><p>更新服务器的各类统计信息，比如时间、内存占用、数据库占用情况等。</p></li> <li><p>清理数据库中的过期键值对。</p></li> <li><p>关闭和清理连接失效的客户端。</p></li> <li><p>尝试进行AOF或RDB持久化操作。</p></li> <li><p>如果服务器是主服务器，那么对从服务器进行定期同步。</p></li> <li><p>如果处于集群模式，对集群进行定期同步和连接测试。</p></li></ul> <p>Redis服务器以<strong>周期性</strong>事件的方式来运行<code>servercron</code>函数，在服务器运行期间，每隔一段时间，servercron就会执行一次，直到服务器关闭为止。</p> <h2 id="事件的调度和执行"><a href="#事件的调度和执行" class="header-anchor">#</a> 事件的调度和执行</h2> <p>服务器有文件事件和时间事件这两种事件，因为Redis是单线程的程序，那么这些事件就避免不了调度的问题。</p> <p>服务器运行的流程可以用下面的流程图来概括。</p> <p><img src="http://img.fosuchao.com/20200522174743.png" alt=""></p> <h4 id="事件的调度和执行规则"><a href="#事件的调度和执行规则" class="header-anchor">#</a> 事件的调度和执行规则</h4> <p>1）<code>aeApiPoll</code>函数的最大阻塞时间由到达时间最接近当前时间的时间事件决定，这个方法既可以避免服务器对时间事件进行频繁的轮询（忙等待),也可以确保<code>aeApiPoll</code>函数不会阻塞过长时间。</p> <p>2）因为文件事件是随机出现的，如果等待并处理完一次文件事件之后，仍未有任何时间事件到达，那么服务器将再次等待并处理文件事件。随着文件事件的不断执行，时间会逐渐向时间事件所设置的到达时间逼近，并最终来到到达时间，这时服务器就可以开始处理到达的时间事件了。</p> <p>3）对文件事件和时间事件的处理都是<strong>同步、有序、原子</strong>地执行的，服务器不会中途中断事件处理，也不会对事件进行抢占，因此，不管是文件事件的处理器，还是时间事件的处理器，它们都会尽可地减少程序的阻塞时间，并在有需要时主动让出执行权，从而降低造成事件饥饿的可能性。比如说，在命令回复处理器将一个命令回复写人到客户端套接字时，如果写人字节数超过了一个预设常量的话，命令回复处理器就会主动用break跳出写入循环，将余下的数据留到下次再写；另外，时间事件也会将非常耗时的持久化操作放到子线程或者子进程执行。</p> <p>4）因为时间事件在文件事件后面执行。并且事件不会发生抢占。所以时间事件的实际执行时间会晚于事件设定的到达时间。</p> <h2 id="重点回顾"><a href="#重点回顾" class="header-anchor">#</a> 重点回顾</h2> <ul><li><p>Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件两类。</p></li> <li><p>文件事件处理器是基于Reactor模式实现的网络通信程序。</p></li> <li><p>文件事件是对套接字操作的抽象：每次套接字变为可应答（acceptable）、可写（writeable）或者可读（readable）时，相应的文件事件就会产生。</p></li> <li><p>文件事件分为AE_READABLE事件（读事件）和AE_WRITEABLE事件（写事件）两类。</p></li> <li><p>时间事件分为定时事件和周期性事件：定时事件只在指定的时间到达一次，而周期性事件则每隔一段时间到达一次。</p></li> <li><p>服务器在一般情况下只执行servercron函数一个时间事件，并且这个事件是周期性事件。</p></li> <li><p>文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程中也不会进行抢占。</p></li> <li><p>时间事件的实际处理时间通常会比设定的到达时间晚一些。</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/数据库/MySQL索引最佳实践.html" class="prev">
        /数据库/MySQL索引最佳实践.html
      </a></span> <span class="next"><a href="/数据库/springboot使用h2数据库.html">
        /数据库/springboot使用h2数据库.html
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b94221b.js" defer></script><script src="/assets/js/2.60568d92.js" defer></script><script src="/assets/js/27.9e876760.js" defer></script>
  </body>
</html>
